package Services;

import jakarta.mail.*;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeMessage;

import java.time.LocalDateTime;
import java.util.Properties;

public class EmailService {

    // ✅ Gmail account
    private static final String FROM_EMAIL = "talentbridge.app@gmail.com";

    // ✅ Google App Password (16 chars)
    private static final String APP_PASSWORD = "bkeqrffipwtgykdr";

    private Session buildSession() {
        Properties props = new Properties();
        props.put("mail.smtp.host", "smtp.gmail.com");
        props.put("mail.smtp.port", "587");
        props.put("mail.smtp.auth", "true");
        props.put("mail.smtp.starttls.enable", "true");

        // optional debug
        // props.put("mail.debug", "true");

        return Session.getInstance(props, new Authenticator() {
            @Override
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(FROM_EMAIL, APP_PASSWORD);
            }
        });
    }

    // ✅ the missing method (your error is here)
    private void sendEmail(String toEmail, String subject, String body) throws Exception {
        Message msg = new MimeMessage(buildSession());

        msg.setFrom(new InternetAddress(FROM_EMAIL, "TalentBridge"));
        msg.setRecipients(Message.RecipientType.TO, InternetAddress.parse(toEmail));
        msg.setSubject(subject);
        msg.setText(body);

        Transport.send(msg);
        System.out.println("✅ Email sent to " + toEmail);
    }

    public void sendResetCode(String toEmail, String code) throws Exception {
        String subject = "TalentBridge - Password Reset Code";
        String body = "Your password reset code is: " + code + "\n\n"
                + "This code expires in 10 minutes.\n"
                + "If you didn’t request this, ignore this email.";

        sendEmail(toEmail, subject, body);
    }

    public void sendLoginSuccess(String toEmail, String firstName) throws Exception {
        String subject = "✅ Login Successful - TalentBridge";
        String name = (firstName == null || firstName.isBlank()) ? "User" : firstName;

        String body = """
                Hello %s,

                You have successfully logged in to TalentBridge.
                Time: %s

                If this wasn't you, please change your password immediately.

                - TalentBridge
                """.formatted(name, LocalDateTime.now());

        sendEmail(toEmail, subject, body);
    }
}