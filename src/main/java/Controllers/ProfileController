package Controllers;

import Models.Candidate;
import Models.Recruiter;
import Models.User;
import Services.ProfileService;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import utils.InputValidator;
import utils.Session;
import Services.UserService;
import Services.RecruiterService;
import Services.LuxandFaceService;
import javafx.stage.FileChooser;
import java.io.File;
import java.nio.file.Files;


public class ProfileController {

    @FXML private TextField tfFirstName;
    @FXML private TextField tfEmail;
    @FXML private TextField tfPhone;
    @FXML private PasswordField pfPassword;
    @FXML private Label lblStatus;

    // recruiter
    @FXML private VBox recruiterBlock;
    @FXML private TextField tfCompanyName;
    @FXML private TextField tfCompanyLocation;

    // candidate
    @FXML private VBox candidateBlock;
    @FXML private TextField tfCandidateLocation;
    @FXML private TextField tfEducationLevel;
    @FXML private TextField tfExperienceYears;
    @FXML private TextField tfCvPath;
    @FXML private Button btnEnableFace;
    @FXML private Button btnDisableFace;

    private final ProfileService service = new ProfileService();

    @FXML
    public void initialize() {
        loadMyProfile();
    }

    private void loadMyProfile() {
        try {
            Long userIdObj = Session.getUserId();
            if (userIdObj == null) {
                lblStatus.setText("Not logged in.");
                return;
            }
            long userId = userIdObj;

            User u = Session.getCurrentUser();
            boolean isRecruiter = u instanceof Recruiter;
            boolean isCandidate = u instanceof Candidate;

            ProfileService.UserProfile p = service.getUserProfile(userId);

            tfFirstName.setText(p.firstName());
            tfEmail.setText(p.email());
            tfPhone.setText(p.phone() == null ? "" : p.phone());

            recruiterBlock.setVisible(isRecruiter);
            recruiterBlock.setManaged(isRecruiter);

            candidateBlock.setVisible(isCandidate);
            candidateBlock.setManaged(isCandidate);

            String faceId = new UserService().getFacePersonId(userId); // method you add below

            boolean enabled = (faceId != null && !faceId.isBlank());

            btnEnableFace.setVisible(!enabled);
            btnEnableFace.setManaged(!enabled);

            btnDisableFace.setVisible(enabled);
            btnDisableFace.setManaged(enabled);

            if (isRecruiter) {
                ProfileService.RecruiterInfo r = service.getRecruiterInfo(userId);
                tfCompanyName.setText(r.companyName());
                tfCompanyLocation.setText(r.companyLocation());
            }

            if (isCandidate) {
                ProfileService.CandidateInfo c = service.getCandidateInfo(userId);
                tfCandidateLocation.setText(c.location());
                tfEducationLevel.setText(c.educationLevel());
                tfExperienceYears.setText(c.experienceYears() == null ? "" : String.valueOf(c.experienceYears()));
                tfCvPath.setText(c.cvPath());
            }

            lblStatus.setText("Loaded ✅");

        } catch (Exception e) {
            e.printStackTrace();
            lblStatus.setText("Load failed: " + e.getMessage());
        }
    }

    @FXML
    private void handleSave() {
        try {
            Long userIdObj = Session.getUserId();
            if (userIdObj == null) {
                showError("Not logged in.");
                return;
            }
            long userId = userIdObj;

            User u = Session.getCurrentUser();
            boolean isRecruiter = u instanceof Recruiter;
            boolean isCandidate = u instanceof Candidate;

            // ===== Validations =====
            String err;

            err = InputValidator.validateName(tfFirstName.getText().trim(), "Full name");
            if (err != null) { showError(err); return; }

            err = InputValidator.validatePhone8(tfPhone.getText().trim());
            if (err != null) { showError(err); return; }

            String newPass = pfPassword.getText();
            if (newPass != null && !newPass.isBlank()) {
                err = InputValidator.validateStrongPassword(newPass);
                if (err != null) { showError(err); return; }
            } else {
                newPass = null; // keep old password
            }

            // ===== Update users table =====
            service.updateUserCore(
                    userId,
                    tfFirstName.getText().trim(),
                    tfPhone.getText().trim(),
                    newPass
            );

            // ===== Type-specific update =====
            if (isRecruiter) {
                if (tfCompanyName.getText().trim().isEmpty()) { showError("Company name is required."); return; }

                service.updateRecruiterInfo(
                        userId,
                        tfCompanyName.getText().trim(),
                        tfCompanyLocation.getText().trim()
                );
            }

            if (isCandidate) {
                Integer years = null;
                String y = tfExperienceYears.getText().trim();
                if (!y.isEmpty()) {
                    try { years = Integer.parseInt(y); }
                    catch (NumberFormatException ex) { showError("Experience years must be a number."); return; }
                }

                String cv = tfCvPath.getText().trim();
                err = InputValidator.validateCvPath(cv);
                if (err != null) { showError(err); return; }

                service.updateCandidateInfo(
                        userId,
                        tfCandidateLocation.getText().trim(),
                        tfEducationLevel.getText().trim(),
                        years,
                        cv
                );
            }

            pfPassword.clear();
            lblStatus.setText("Saved ✅");

        } catch (Exception e) {
            e.printStackTrace();
            lblStatus.setText("Save failed: " + e.getMessage());
        }
    }

    private void showError(String msg) {
        new Alert(Alert.AlertType.ERROR, msg).showAndWait();
    }
    @FXML
    private void handleEnableFaceLogin() {
        try {
            User me = Session.getCurrentUser();
            if (me == null) {
                showError("Not logged in.");
                return;
            }

            FileChooser fc = new FileChooser();
            fc.setTitle("Select a clear face photo");
            fc.getExtensionFilters().add(
                    new FileChooser.ExtensionFilter("Images", "*.png", "*.jpg", "*.jpeg")
            );

            File file = fc.showOpenDialog(tfEmail.getScene().getWindow()); // ✅ HERE
            if (file == null) return;

            byte[] bytes = Files.readAllBytes(file.toPath());

            UserService us = new UserService();
            String existingUuid = us.getFacePersonId(me.getId());
            System.out.println("existingUuid from DB = [" + existingUuid + "]");

            LuxandFaceService lux = new LuxandFaceService();

            if (existingUuid == null || existingUuid.isBlank()) {
                String uuid = lux.addPerson(me.getEmail(), bytes, file.getName());
                us.enableFaceLogin(me.getId(), uuid);

                System.out.println("Created Luxand person UUID=" + uuid);
                showAlert("Success", "Face login enabled ✅\nUUID: " + uuid);
            } else {
                lux.addFace(existingUuid.trim(), bytes, file.getName());
                System.out.println("Added extra face to UUID=" + existingUuid);
                showAlert("Success", "New face added ✅");
            }

        } catch (Exception e) {
            e.printStackTrace();
            showAlert("Error", "Enable/Add face failed: " + e.getMessage());
        }
    }

    @FXML
    private void handleDisableFaceLogin() {
        try {
            User me = Session.getCurrentUser();
            if (me == null) return;

            new UserService().disableFaceLogin(me.getId());
            showAlert("Done", "Face login disabled ✅");

        } catch (Exception e) {
            e.printStackTrace();
            showAlert("Error", "Disable face failed: " + e.getMessage());
        }
    }

    private void showAlert(String title, String msg) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(msg);
        alert.showAndWait();
    }





}